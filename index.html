<!doctype html>
<html>
<head>
	<script src="//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js">
	</script>
</head>
<body>
	<video style="vertical-align: top;" autoplay></video>
	<canvas id="screenshot-canvas" style="display:none;"></canvas>
	<img >
	<button id="capture" style="display:none;">Take a Picture</button>
	<button id="save" style="display:none;">Save in Dropbox</button>
	<script>
	var client = new Dropbox.Client({ key: "0oojgpkjslrqw36" });
	//client.authDriver(new Dropbox.Drivers.Popup());
	client.authenticate(function(error, client) {
		if (error) {
			console.log(error);
			return error;
		}
		alert("auth ok");
		navigator.getUserMedia  = navigator.getUserMedia ||
		navigator.webkitGetUserMedia ||
		navigator.mozGetUserMedia ||
		navigator.msGetUserMedia;

		var video = document.querySelector('video');
		var errorCallback = function () {
			alert("Sorry, error occured while obtaining video stream.");
		}
		// Callback when camera video stream captured
		var camLoaded = function () {
			var capBtn = document.querySelector('#capture');
			var saveBtn = document.querySelector('#save')
			var video = document.querySelector('video');
			var canvas = document.querySelector('canvas');
			var ctx = canvas.getContext('2d');
			
			capBtn.style.display = 'block';
			saveBtn.style.display = 'block'
			capBtn.onclick = function () {
				snapshot();
				return false;
			}
			saveBtn.onclick = function () {
				save();
				saveBtn.setAttribute("disabled","true");
				saveBtn.textContent = "Please Wait...";
    	    	return false;
			}
			// usedn to take a picutre
			function snapshot () {
				canvas.style.height = video.videoHeight + "px";
				canvas.style.width = video.videoWidth + "px";
				ctx.canvas.width  = video.videoWidth;
		    	ctx.canvas.height = video.videoHeight;
				ctx.drawImage(video, 0, 0);
				document.querySelector('img').src = canvas.toDataURL('image/png');
			}
			// save picture to Dropbox
			function save () {
				var dataURL = document.querySelector('img').src;
				if(!dataURL){
					alert("Please take a picture first.");
				}
				// covert data URL to Blob and upload it
				var blobBin = atob(dataURL.split(',')[1]);
				var array = [];
				for(var i = 0; i < blobBin.length; i++) {
					array.push(blobBin.charCodeAt(i));
				}
				var file=new Blob([new Uint8Array(array)], {type: 'image/png'});
				client.writeFile(new Date()+".png", file, function(error, stat) {
					saveBtn.removeAttribute("disabled");
					saveBtn.textContent = "Save in Dropbox";
					if (error) {
						console.log(error);
    	    			return error;  // Something went wrong.
    	    		}
    	    		alert("File saved successfully!");
    	    	});
			}
		}
		// get user media, and begin to capture camera video stream
		if (navigator.getUserMedia) {
			navigator.getUserMedia({video: {
				mandatory: {
					maxWidth: 640,
					maxHeight: 360
				}
			}}, function (stream) {
				video.src = window.URL.createObjectURL(stream);
				camLoaded();
			}, errorCallback);
		} else {
  			video.src = 'somevideo.webm'; // fallback.
  		}	
  	});
</script>
</body>
</html>
